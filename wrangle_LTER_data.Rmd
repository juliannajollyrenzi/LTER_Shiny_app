---
title: "Wrangle LTER data"
author: "Julianna Renzi"
date: "1/22/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse) # data wrangling
require(here) # relative file paths
require(gghighlight) # highlight certain lines on graphs

```

## Other (non-coral) Benthic Invertebrates

In this script we wrangle the data into a similar format that can be used in the app. We'll start with the invertebrate data to get summarized values for each year.

These data can be found at: http://mcrlter.msi.ucsb.edu/cgi-bin/showDataset.cgi?docid=knb-lter-mcr.7 with the abstract "The data presented here are the abundances of the major invertebrate herbivores and corallivores on Moorea coral reefs. Abundances are estimated in 4 fixed quadrats along 5 permanent transects at each of 4 habitats at 2 sites on each of the 3 shores of Moorea each year. Counts are made in one-meter-squared quadrats." The dataset ranges from 2005-2020 and spans LTER 1, LTER 2, LTER 3, LTER 4, LTER 5, and LTER 6.

Acanthaster/Culcita/Linckia are inconsistent and in laster years are noted when they're 1m away. In 2005-2006 the "No invertebrate observed" notation was used for no invertebrates, but in 2007 onwards they are listed as the species name with a count of 0. 2005-2006 was spread over two years because it took two years to get the base data everywhere but from then on it's one survey/year.

```{r, message=FALSE, warning=FALSE}
# read in the data 

inverts <- read_csv(here("untouched_data", "MCR_LTER_Annual_Survey_Herbiv_Invert_20201026.csv")) %>% 
  filter(Year != "2005-2006") %>% # filter out 2005-2006 because it was done over two years and had a different notation scheme
  filter(!is.na(Taxonomy)) # filter out weird NA row that happened when we used read_csv()

# summarize to get yearly values by species
taxon_summ <- inverts %>% 
  group_by(Year, Taxonomy) %>% 
  summarize(Total_abund = sum(Count), 
            N = n(), 
            Mean_abund_per_m2 = sum(Count)/480) %>% # 5 transects * 4 quadrats/transect * 4 habitats (2 depths for outer, fringing, and backreef/lagoon) * 6 LTER sites each year = 480 quadrats total
  filter(Taxonomy != "No invertebrate observed") %>% # get rid of empty lines
  filter(!str_detect(Taxonomy, "(1m away)")) # remove these so only have what we observed in the 1m^2 quadrats

# could also summarize by site
site_summ <- inverts %>% 
  group_by(Year, Taxonomy, Site) %>% 
  summarize(Total_abund = sum(Count), 
            N = n(), 
            Mean_abund_per_m2 = sum(Count)/80) %>% # 5 transects * 4 quadrats/transect * 4 habitats (2 depths for outer, fringing, and backreef/lagoon) = 80 quadrats total
  filter(Taxonomy != "No invertebrate observed") %>% # get rid of empty lines
  filter(!str_detect(Taxonomy, "(1m away)")) # remove these so only have what we observed in the 1m^2 quadrats

# can also do by habitat
habit_summ <- inverts %>% 
  group_by(Year, Taxonomy, Habitat) %>% 
  summarize(Total_abund = sum(Count), 
            N = n(), 
            Mean_abund_per_m2 = sum(Count)/120) %>% # 5 transects * 4 quadrats/transect * * 6 LTER sites= 80 quadrats total
  filter(Taxonomy != "No invertebrate observed") %>% # get rid of empty lines
  filter(!str_detect(Taxonomy, "(1m away)")) # remove these so only have what we observed in the 1m^2 quadrats

```

Now explore potential plots

```{r, message=FALSE, warning=FALSE}
# taxonomy over time
taxon_summ %>% 
  ggplot(aes(x = Year, y = Mean_abund_per_m2, group = Taxonomy)) +
  geom_line(aes(colour = Taxonomy)) + 
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#B2DF8A",
                                "#33A02C", "#FB9A99", "#E31A1C",
                                "#FDBF6F", "#FF7F00", "#CAB2D6",
                                "#6A3D9A", "#FFFF99", "#B15928",
                                "#666666", "#E7298A")) +
  theme_bw() +
  ylab(expression(paste("Average abundance per ", m^2))) + 
  xlab("Survey year")
```
Break it up by habitat then by site
```{r, nessage=FALSE, warning=FALSE}
habit_summ %>% 
  ggplot(aes(x = Year, y = Mean_abund_per_m2, group = Taxonomy)) +
  geom_line(aes(colour = Taxonomy)) + 
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#B2DF8A",
                                "#33A02C", "#FB9A99", "#E31A1C",
                                "#FDBF6F", "#FF7F00", "#CAB2D6",
                                "#6A3D9A", "#FFFF99", "#B15928",
                                "#666666", "#E7298A")) +
  theme_minimal() +
  ylab("Average abundance per m^2") + 
  xlab("Survey year") +
  facet_wrap(~Habitat) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

```{r, nessage=FALSE, warning=FALSE}
site_summ %>% 
  ggplot(aes(x = Year, y = Mean_abund_per_m2, group = Taxonomy)) +
  geom_line(aes(colour = Taxonomy)) + 
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#B2DF8A",
                                "#33A02C", "#FB9A99", "#E31A1C",
                                "#FDBF6F", "#FF7F00", "#CAB2D6",
                                "#6A3D9A", "#FFFF99", "#B15928",
                                "#666666", "#E7298A")) +
  theme_minimal() +
  ylab("Average abundance per m^2") + 
  xlab("Survey year") +
  facet_wrap(~Site) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## Now look at benthos

These data were taken from: http://mcrlter.msi.ucsb.edu/cgi-bin/showDataset.cgi?docid=knb-lter-mcr.8.

The abstract online is: "The sampling described here quantifies the relative abundances of corals (aggregate abundance) and the other major benthic components including algal turfs, macroalgae, crustose corallines, and other sessile invertebrates. Abundance is estimated yearly at each of 6 sites (2 per shore) around the island. At each site, and in each of 4 habitats (fringing reef, backreef, forereef 10-m depth, forereef 17-m depth), 5 permanent 10-m long transects have been established and abundance estimates are made at fixed positions along each transect (n=10, 0.25 m2 quadrats per transect) allowing a repeated measures statistical analysis for the detection of temporal trends... ...The original design was established to support a nested, factorial ANOVA experimental approach, but the sampling strategy is amenable to many other designs to meet the users needs. In the factorial construct, shore (north, southeast, or southwest) is treated as a fixed factor, site (LTER 1-6) as a random factor nested within shore, and time as a repeated measures factor based on individual quadrats that are relocated. In the case of the outer reef, depth (10 or 17 m) also was used as a fixed factor to contrast the effects of time and shore between depths"

```{r, message = FALSE, warning=FALSE}
benthos <- read_csv(here("untouched_data", "MCR_LTER_Annual_Survey_Benthic_Cover_20201221.csv")) %>% 
  filter(!is.na(Year)) # filter out NAs

# see there are a ~85 species (likely too many to plot on one graph clearly)
spp_list <- as.data.frame(benthos %>% select(Taxonomy_Substrate_Functional_Group) %>% unique)
# can write it to a CSV to assign groupings (below)
# write.csv(spp_list, file = "Benthic_species_key.csv")

# summarize the data by taxonomy
benth_taxon <- benthos %>% 
  group_by(Year, Taxonomy_Substrate_Functional_Group) %>% 
  summarize(Total_percent = sum(Percent_Cover), 
            Mean_perc_cov = sum(Percent_Cover)/1200, # 1200 because it's 6 sites * 4 gabitats * 5 transects * 10 0.25 m^2 quadrats 
            N = n())

# by habitat
benth_habit <- benthos %>% 
  group_by(Year, Taxonomy_Substrate_Functional_Group, Habitat) %>% 
  summarize(Total_percent = sum(Percent_Cover), 
            Mean_perc_cov = sum(Percent_Cover)/300, # 1200 because it's 6 sites * 5 transects * 10 0.25 m^2 quadrats 
            N = n())

# by site
benth_site <- benthos %>% 
  group_by(Year, Taxonomy_Substrate_Functional_Group, Site) %>% 
  summarize(Total_percent = sum(Percent_Cover), 
            Mean_perc_cov = sum(Percent_Cover)/200, # 1200 because it's 4 gabitats * 5 transects * 10 0.25 m^2 quadrats 
            N = n())
```

```{r}
# try plotting with gghighlight
benth_taxon %>% 
  ggplot(aes(x = Year, y = Mean_perc_cov, group = Taxonomy_Substrate_Functional_Group)) +
  geom_line(aes(colour = Taxonomy_Substrate_Functional_Group)) +
  theme_bw() +
  scale_color_brewer(palette = "Dark2") +
  gghighlight(max(Mean_perc_cov) > 12) +
  ylab("Mean percent cover (%)") + 
  xlab("Survey year") 

# by site
benth_site %>% 
  ggplot(aes(x = Year, y = Mean_perc_cov, group = Taxonomy_Substrate_Functional_Group)) +
  geom_line(aes(color = Taxonomy_Substrate_Functional_Group)) + 
  theme_bw() +
  gghighlight(max(Mean_perc_cov) > 13) +
  scale_color_brewer(palette = "Dark2") +
  ylab("Mean percent cover (%)") + 
  xlab("Survey year") + 
  facet_wrap(~Site)

# by habitat
benth_habit %>% 
  ggplot(aes(x = Year, y = Mean_perc_cov, group = Taxonomy_Substrate_Functional_Group)) +
  geom_line(aes(colour = Taxonomy_Substrate_Functional_Group)) + 
  facet_wrap(~Habitat) +
  theme_bw() +
  scale_color_brewer(palette = "Dark2") +
  gghighlight(max(Mean_perc_cov) > 13) +
  ylab("Mean percent cover (%)") + 
  xlab("Survey year") 



```

Simplify benthos using a key we classified in Excel

```{r}
benthic_spp_key <- read_csv("Benthic_species_key.csv")
benthos_grouped <- benthos %>% 
  full_join(benthic_spp_key, by = "Taxonomy_Substrate_Functional_Group")
```

Now look by habitat 

```{r}
# now can summarize in the same way
# by habitat
benth_habit_group <- benthos_grouped %>% 
  group_by(Year, Spp_grouping, Habitat) %>% 
  summarize(Total_percent = sum(Percent_Cover), 
            Mean_perc_cov = sum(Percent_Cover)/300, # 300 because it's 6 sites *  5 transects * 10 0.25 m^2 quadrats 
            N = n())

# then plot
benth_habit_group %>% 
  filter(Spp_grouping == "Crustose_corallines" |
         Spp_grouping == "Hard_coral" |
         Spp_grouping == "Macroalgae" |
         Spp_grouping == "Turf") %>% 
  ggplot(aes(x = Year, y = Mean_perc_cov, group = Spp_grouping)) +
  geom_line(aes(colour = Spp_grouping)) +
  scale_color_brewer(palette = "Dark2") +
  theme_minimal() +
  ylab("Mean percent cover (%)") + 
  xlab("Survey year") +
  facet_wrap(~Habitat)

```

Now look by LTER site

```{r}
benth_site_group <- benthos_grouped %>% 
  group_by(Year, Spp_grouping, Site) %>% 
  summarize(Total_percent = sum(Percent_Cover), 
            Mean_perc_cov = sum(Percent_Cover)/200, # 200 because it's 4 habitats * 5 transects * 10 0.25 m^2 quadrats 
            N = n())

# then plot
benth_site_group %>% 
  filter(Spp_grouping == "Crustose_corallines" |
         Spp_grouping == "Hard_coral" |
         Spp_grouping == "Macroalgae" |
         Spp_grouping == "Turf") %>% 
  ggplot(aes(x = Year, y = Mean_perc_cov, group = Spp_grouping)) +
  geom_line(aes(colour = Spp_grouping)) +
  scale_color_brewer(palette = "Dark2") +
  theme_minimal() +
  ylab("Mean percent cover (%)") + 
  xlab("Survey year") +
  facet_wrap(~Site)
```


Macroalgal diversity through time

```{r}
#benth_site_group
```



